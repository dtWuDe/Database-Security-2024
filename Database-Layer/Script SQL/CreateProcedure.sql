/*----------------------------------------------------------
MASV						: 21120572
HO TEN CAC THANH VIEN NHOM	: LE TRUNG NGUYEN, NGU DUY TINH, LE TIEN PHAT, TRAN BUI THAI SON
LAB							: 03 - NHOM
NGAY						: 18/4/2024
----------------------------------------------------------*/

USE QLSVNhom
GO

ALTER DATABASE QLSVNhom
SET COMPATIBILITY_LEVEL = 120;
GO

CREATE OR ALTER PROCEDURE SP_INS_PUBLIC_NHANVIEN
	@MANV VARCHAR(20), 
	@HOTEN NVARCHAR(100), 
	@EMAIL VARCHAR(20), 
	@LUONGCB NUMERIC, 
	@TENDN NVARCHAR(100), 
	@MK NVARCHAR(20)
AS
BEGIN

	DECLARE @STRSQL NVARCHAR(MAX) 
	set @STRSQL = 'CREATE ASYMMETRIC KEY '    + quoteName(@MANV) + ' ' +
                 'WITH ALGORITHM = RSA_512 ' + 
                 'ENCRYPTION BY PASSWORD = ' + quoteName(@MK , nchar(39))
        exec (@STRSQL)

	INSERT INTO NHANVIEN (MANV, HOTEN, EMAIL, LUONG, TENDN, MATKHAU, PUBKEY) 
	VALUES (@MANV, @HOTEN, @EMAIL, ENCRYPTBYASYMKEY(ASYMKEY_ID(@MANV),CAST(@LUONGCB AS VARCHAR(MAX))), @TENDN, HASHBYTES('SHA1', @MK), @MANV)

END;
GO

CREATE OR ALTER PROCEDURE SP_SEL_PUBLIC_NHANVIEN
@MANV NVARCHAR(100),
@MK NVARCHAR(20)
AS 
BEGIN
	SELECT MANV, HOTEN, EMAIL, CAST(DECRYPTBYASYMKEY(ASYMKEY_ID(@MANV), LUONG, @MK) AS VARCHAR(MAX)) AS LUONGCB 
	FROM NHANVIEN
	WHERE MANV = @MANV AND MATKHAU = HASHBYTES('SHA1', @MK) 
END;
GO

-- PROCEDURE INSERT SINH VIEN
CREATE OR ALTER PROCEDURE SP_INS_SINHVIEN
@MASV NVARCHAR(20),
@HOTEN NVARCHAR(100),
@NGAYSINH DATETIME,
@DIACHI NVARCHAR(200),
@MALOP VARCHAR (20),
@TENDN NVARCHAR(100),
@MATKHAU VARCHAR(20)
AS
	DECLARE @HASH_VALUE_MATKHAU VARBINARY(2000)
BEGIN
	SET @HASH_VALUE_MATKHAU = HASHBYTES('SHA1', @MATKHAU)
	INSERT INTO SINHVIEN VALUES (@MASV, @HOTEN, @NGAYSINH, @DIACHI, @MALOP, @TENDN, @HASH_VALUE_MATKHAU)
END;
GO

---- Grant encrypt but not decrypt
-- GRANT VIEW DEFINITION ON ASYMMETRIC KEY::NV01 TO NV01;

-- Grant enceypt and decrypt
GRANT CONTROL ON ASYMMETRIC KEY::NV01 TO NV01;

-- TEST
---------------------------------------------------------------------------------------------------------
EXEC SP_INS_PUBLIC_NHANVIEN 'NV01', N'NGUYEN VAN A', 'nva@yahoo.com', 3000000, 'NVA', '123456'
EXEC SP_INS_PUBLIC_NHANVIEN 'NV02', N'NGUYEN VAN B', 'nvb@yahoo.com', 2000000, 'NVB', '1234567'

INSERT INTO LOP VALUES ('CNTT-K35', 'CONG NGHE THONG TIN K35', 'NV01'),
					   ('KHMT-K35', 'KHOA HOC MOI TRUONG K35', 'NV02');


--DROP ASYMMETRIC KEY NV01
--DROP ASYMMETRIC KEY NV02
--DELETE FROM NHANVIEN WHERE MANV = 'NV01'
--DELETE FROM NHANVIEN WHERE MANV = 'NV02'


EXEC SP_SEL_PUBLIC_NHANVIEN 'NV01', '123456'

EXEC SP_INS_SINHVIEN 'SV01', 'TRAN VAN A', '1/1/1990', '280 AN DUONG VUONG', 'CNTT-K35', 'NVA', '123456'
EXEC SP_INS_SINHVIEN 'SV02', 'TRAN VAN B', '1/2/1990', '360 TRUONG CHINH', 'KHMT-K35', 'NVA', '12345678'
---------------------------------------------------------------------------------------------------------

INSERT HOCPHAN VALUES ('CSC10007', N'Hệ điều hành', 4),
					('CSC13002', 'Nhập môn công nghệ phần mềm', 4),
					('CSC14003', 'Cơ sở trí tuệ nhân tạo', 4),
					('CSC14007', 'Nhập môn phân tích độ phức tạp thuật toán', 4),
					('CSC15005', 'Nhập môn mã hóa – mật mã', 4);
GO

INSERT INTO BANGDIEM (MASV, MAHP) VALUES ('SV01', 'CSC10007'),
('SV01', 'CSC13002'),
('SV01', 'CSC14003'),
('SV01', 'CSC14007'),
('SV01', 'CSC15005'),
('SV02', 'CSC10007'),
('SV02', 'CSC13002'),
('SV02', 'CSC14003'),
('SV02', 'CSC14007'),
('SV02', 'CSC15005');
GO

SELECT* FROM NHANVIEN
SELECT* FROM LOP
SELECT* FROM SINHVIEN

SELECT* FROM HOCPHAN
SELECT* FROM BANGDIEM